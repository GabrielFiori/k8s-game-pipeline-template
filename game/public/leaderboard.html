<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üêß Flappy Penguin - Ranking</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="leaderboard">
            <h1>üèÜ Ranking dos Pinguins</h1>
            
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span>Atualiza√ß√£o em tempo real</span>
            </div>
            
            <!-- Nova se√ß√£o para visualizar o jogo do l√≠der -->
            <div class="leader-viewer">
                <h3>üéÆ Assistindo o L√≠der</h3>
                <div id="leaderInfo" class="leader-info">
                    <span>Nenhum jogador ativo no momento</span>
                </div>
                <div class="game-viewer">
                    <canvas id="viewerCanvas" width="300" height="450"></canvas>
                </div>
            </div>
            
            <div id="leaderboardList" class="leaderboard-list">
                <div class="loading">Carregando ranking...</div>
            </div>
            
            <div class="current-players">
                <h3>üéÆ Jogadores Online</h3>
                <div id="onlinePlayers" class="online-players">
                    <div class="no-players">Nenhum jogador online no momento</div>
                </div>
            </div>
            
            <button id="backBtn" class="btn btn-primary">‚Üê Voltar ao Menu</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const leaderboardList = document.getElementById('leaderboardList');
        const onlinePlayers = document.getElementById('onlinePlayers');
        const backBtn = document.getElementById('backBtn');
        const leaderInfo = document.getElementById('leaderInfo');
        const viewerCanvas = document.getElementById('viewerCanvas');
        const viewerCtx = viewerCanvas.getContext('2d');

        // Prevenir zoom duplo toque
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // Vari√°veis para o visualizador
        let currentLeaderGame = null; // { playerName, gameState }
        let allPlayersList = [];
        const SCALE = 0.75; // Escala para o canvas menor

        // Conectar e solicitar dados
        socket.on('connect', () => {
            console.log('Conectado ao servidor');
            // Registrar como espectador para receber o leaderboard imediatamente
            socket.emit('spectatorJoin');
        });

        // Atualizar leaderboard
        socket.on('leaderboardUpdate', (leaderboard) => {
            updateLeaderboard(leaderboard);
        });

        // Atualizar jogadores online (preferir lista completa enviada pelo servidor)
        socket.on('allPlayersUpdate', (players) => {
            allPlayersList = Array.isArray(players) ? players : [];
            renderOnlinePlayers();
            // if we have a leader view, redraw to include other players
            drawLeaderGame();
        });

        // Fallback: incremental score updates
        socket.on('playerScoreUpdate', (playerData) => {
            // update the entry in allPlayersList if present
            const idx = allPlayersList.findIndex(p => p.id === playerData.playerId);
            if (idx !== -1) {
                allPlayersList[idx].score = playerData.score;
                allPlayersList[idx].name = playerData.playerName || allPlayersList[idx].name;
            } else {
                // add minimal entry
                allPlayersList.push({ id: playerData.playerId, name: playerData.playerName, score: playerData.score, isPlaying: true, gameState: null });
            }
            renderOnlinePlayers();
        });

        // Receber estado do jogo do l√≠der
        socket.on('leaderGameState', (data) => {
            if (data) {
                currentLeaderGame = data; // keep both playerName and gameState
                leaderInfo.innerHTML = `
                    <div class="leader-status">
                        <span class="leader-name">üêß ${data.playerName}</span>
                        <span class="leader-score">Pontua√ß√£o: ${data.gameState.score}</span>
                    </div>
                `;
                drawLeaderGame();
            } else {
                currentLeaderGame = null;
                leaderInfo.innerHTML = '<span>Nenhum jogador ativo no momento</span>';
                clearViewerCanvas();
            }
        });

        function updateLeaderboard(leaderboard) {
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<div class="no-scores">Nenhuma pontua√ß√£o registrada ainda</div>';
                return;
            }

            let html = '';
            leaderboard.forEach((entry, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
                html += `
                    <div class="leaderboard-entry ${index < 3 ? 'podium' : ''}">
                        <span class="position">${medal}</span>
                        <span class="name">${entry.name}</span>
                        <span class="score">${entry.score}</span>
                    </div>
                `;
            });
            leaderboardList.innerHTML = html;
        }

        let currentPlayers = new Map();

        function updateOnlinePlayer(playerData) {
            currentPlayers.set(playerData.playerId, playerData);
            
            let html = '';
            if (currentPlayers.size === 0) {
                html = '<div class="no-players">Nenhum jogador online no momento</div>';
            } else {
                currentPlayers.forEach((player) => {
                    html += `
                        <div class="online-player">
                            <span class="player-name">üêß ${player.playerName}</span>
                            <span class="player-score">Pontua√ß√£o: ${player.score}</span>
                        </div>
                    `;
                });
            }
            onlinePlayers.innerHTML = html;
        }

        // Fun√ß√µes para desenhar o jogo do l√≠der
        function drawLeaderGame() {
            if (!currentLeaderGame || !currentLeaderGame.gameState) {
                clearViewerCanvas();
                return;
            }

            // Limpar canvas
            viewerCtx.clearRect(0, 0, viewerCanvas.width, viewerCanvas.height);

            // Desenhar fundo
            drawViewerBackground();

            // compute offset so leader's penguin appears at the same X as in the main game
            // main game uses `game.penguin.x = 50` as the player's horizontal position,
            // so replicate that here (scaled for the smaller viewer canvas)
            const leaderState = currentLeaderGame.gameState;
            const leaderPengXScaled = leaderState.penguin.x * SCALE;
            const desiredLeaderX = 50 * SCALE; // match main game's penguin x (50)
            const offset = desiredLeaderX - leaderPengXScaled;

            // Desenhar canos com offset
            drawViewerPipes(leaderState.pipes, offset);

            // Desenhar outros jogadores (se houver)
            if (Array.isArray(allPlayersList) && allPlayersList.length > 0) {
                for (const p of allPlayersList) {
                    try {
                        if (!p || !p.gameState || !p.gameState.penguin) continue;
                        // skip leader - will draw separately
                        if (currentLeaderGame.playerName === p.name) continue;
                        drawViewerPlayer(p, offset, false);
                    } catch (e) {
                        console.warn('drawLeaderGame other player error', e);
                    }
                }
            }

            // Desenhar pinguim do l√≠der em destaque
            drawViewerPlayer({ name: currentLeaderGame.playerName, gameState: leaderState }, offset, true);
        }

        function drawViewerBackground() {
            // C√©u
            const gradient = viewerCtx.createLinearGradient(0, 0, 0, viewerCanvas.height);
            gradient.addColorStop(0, '#74b9ff');
            gradient.addColorStop(1, '#0984e3');
            viewerCtx.fillStyle = gradient;
            viewerCtx.fillRect(0, 0, viewerCanvas.width, viewerCanvas.height);

            // Nuvens simples (ajustadas para o tamanho menor)
            viewerCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            viewerCtx.beginPath();
            viewerCtx.arc(75, 75, 22, 0, Math.PI * 2);
            viewerCtx.arc(90, 75, 30, 0, Math.PI * 2);
            viewerCtx.arc(105, 75, 22, 0, Math.PI * 2);
            viewerCtx.fill();

            viewerCtx.beginPath();
            viewerCtx.arc(225, 112, 18, 0, Math.PI * 2);
            viewerCtx.arc(236, 112, 26, 0, Math.PI * 2);
            viewerCtx.arc(247, 112, 18, 0, Math.PI * 2);
            viewerCtx.fill();
        }

        function drawViewerPipes(pipes, offset=0) {
            viewerCtx.fillStyle = '#27ae60';
            
            pipes.forEach(pipe => {
                const scaledX = (pipe.x * SCALE) + offset;
                const scaledWidth = 60 * SCALE; // PIPE_WIDTH
                const scaledTopHeight = pipe.topHeight * SCALE;
                const scaledBottomY = pipe.bottomY * SCALE;

                // Cano superior
                viewerCtx.fillRect(scaledX, 0, scaledWidth, scaledTopHeight);
                
                // Cano inferior
                viewerCtx.fillRect(scaledX, scaledBottomY, scaledWidth, viewerCanvas.height - scaledBottomY);
                
                // Bordas dos canos
                viewerCtx.fillStyle = '#229954';
                viewerCtx.fillRect(scaledX - 3, scaledTopHeight - 22, scaledWidth + 6, 22);
                viewerCtx.fillRect(scaledX - 3, scaledBottomY, scaledWidth + 6, 22);
                viewerCtx.fillStyle = '#27ae60';
            });
        }

        function drawViewerPlayer(playerEntry, offset=0, isLeader=false) {
            const state = playerEntry.gameState && playerEntry.gameState.penguin ? playerEntry.gameState.penguin : null;
            if (!state) return;

            viewerCtx.save();
            const scaledX = (state.x * SCALE) + offset;
            const scaledY = state.y * SCALE;
            const scaledWidth = state.width * SCALE;
            const scaledHeight = state.height * SCALE;

            const rotation = Math.min(Math.max(state.velocity * 3, -30), 90);
            viewerCtx.translate(scaledX + scaledWidth/2, scaledY + scaledHeight/2);
            viewerCtx.rotate(rotation * Math.PI / 180);

            // cor diferenciada para l√≠der
            viewerCtx.fillStyle = isLeader ? '#0984e3' : 'rgba(45,52,54,0.9)';
            viewerCtx.fillRect(-scaledWidth/2, -scaledHeight/2, scaledWidth, scaledHeight);
            // barriga
            viewerCtx.fillStyle = isLeader ? '#ffffff' : 'rgba(255,255,255,0.9)';
            viewerCtx.fillRect(-scaledWidth/3, -scaledHeight/3, scaledWidth/1.5, scaledHeight/1.5);
            // bico
            viewerCtx.fillStyle = isLeader ? '#f39c12' : 'rgba(243,156,18,0.9)';
            viewerCtx.fillRect(scaledWidth/2 - 4, -2, 6, 4);
            // olho
            viewerCtx.fillStyle = '#ffffff';
            viewerCtx.fillRect(scaledWidth/4, -scaledHeight/3, 6, 6);
            viewerCtx.fillStyle = '#2d3436';
            viewerCtx.fillRect(scaledWidth/4 + 1, -scaledHeight/3 + 1, 3, 3);
            viewerCtx.restore();

            // nome acima
            viewerCtx.save();
            viewerCtx.font = isLeader ? 'bold 18px Arial' : 'bold 14px Arial';
            viewerCtx.textAlign = 'center';
            viewerCtx.fillStyle = '#2d3436';
            viewerCtx.fillText(playerEntry.name, scaledX + scaledWidth/2, scaledY - 8);
            viewerCtx.restore();
        }

        function clearViewerCanvas() {
            viewerCtx.clearRect(0, 0, viewerCanvas.width, viewerCanvas.height);
            
            // Desenhar tela vazia
            viewerCtx.fillStyle = '#ddd';
            viewerCtx.fillRect(0, 0, viewerCanvas.width, viewerCanvas.height);
            
            viewerCtx.fillStyle = '#666';
            viewerCtx.font = '16px Arial';
            viewerCtx.textAlign = 'center';
            viewerCtx.fillText('Aguardando jogador...', viewerCanvas.width/2, viewerCanvas.height/2);
        }

        function renderOnlinePlayers() {
            let html = '';
            if (!Array.isArray(allPlayersList) || allPlayersList.length === 0) {
                html = '<div class="no-players">Nenhum jogador online no momento</div>';
            } else {
                allPlayersList.forEach(p => {
                    html += `
                        <div class="online-player">
                            <span class="player-name">üêß ${p.name}</span>
                            <span class="player-score">Pontua√ß√£o: ${p.score || 0}</span>
                        </div>
                    `;
                });
            }
            onlinePlayers.innerHTML = html;
        }

        // Voltar ao menu
        backBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Inicializar canvas vazio
        clearViewerCanvas();
    </script>
</body>
</html>